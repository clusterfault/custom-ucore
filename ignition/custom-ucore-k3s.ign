{
  "ignition": {
    "version": "3.3.0"
  },
  "passwd": {
    "users": [
      {
        "name": "core",
        "passwordHash": "$y$j9T$2tAyrsoOrXrzVouTo6cJ5.$9oTIcJYHlNer9YmSlzVa/VNr6prkF9j6AA5g4KUpQj0",
        "sshAuthorizedKeys": [
          "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPq+6J0Ssd7bfPcwva85fTheS3I4l3kLP4r04J5ZkEic hsingh@mbp16",
          "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJPm8FHX5EtFK5BUZzlzdhI5A9nWHLVfCEY66djOJS5E harpreet@precision"
        ]
      }
    ]
  },
  "storage": {
    "directories": [
      {
        "path": "/etc/custom-ucore-autorebase",
        "mode": 492
      }
    ],
    "files": [
      {
        "path": "/etc/yum.repos.d/kubernetes.repo",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/5TMOwoCMRRG4T6LyWW0kUBW4BLEIo+fjNy8yM2Is3tRwX66w1ecG28eo2JC7qq6Anv9g/JOsI1s1zm7GKLOSTRfRD8ahTZgSKbzGYaeiz6faPRCCvVD0S4q9RRWBP4lYz80Gugtuum+UaJ+lawZu3oHAAD//5WyNkuyAAAA"
        },
        "mode": 420
      },
      {
        "path": "/etc/yum.repos.d/rancher-k3s-common.repo",
        "contents": {
          "compression": "gzip",
          "source": "data:;base64,H4sIAAAAAAAC/3TNsQrCMBDG8T1P0VGH9izdhEyObq4ikp5HU9Lkwl069O2lRtwcj9/H/+7iEnqSNgzaIsfIqdXixoUeJrlI9la9uQ7aXD7eHOrgaEantMpifSlZzwCSY/ftdTNDGBTqFGoZkIVYIbET9IbSbi/bmylP6AmD7Y1Q5ufvPu0UaPv3Iq/jMmMXaDPvAAAA//8uNPOyygAAAA=="
        },
        "mode": 420
      },
      {
        "overwrite": true,
        "path": "/usr/local/bin/k3s",
        "contents": {
          "source": "https://github.com/k3s-io/k3s/releases/download/v1.31.4%2Bk3s1/k3s",
          "verification": {
            "hash": "sha256-74897e4af26ea383ce50f445752f40ca63a0aef0d90994fb74073c43063eeeb2"
          }
        },
        "mode": 493
      },
      {
        "path": "/etc/rancher/k3s/config.yaml",
        "contents": {
          "compression": "",
          "source": "data:,---%0Adisable%3A%0A-%20servicelb%0A-%20traefik%0A-%20metrics-server%0A-%20local-storage%0A-%20helm-controller%0A"
        },
        "mode": 420
      },
      {
        "path": "/etc/rancher/k3s/kubelet.config",
        "contents": {
          "compression": "",
          "source": "data:,apiVersion%3A%20kubelet.config.k8s.io%2Fv1beta1%0Akind%3A%20KubeletConfiguration%0AshutdownGracePeriod%3A%2060s%0AshutdownGracePeriodCriticalPods%3A%2010s%0A"
        },
        "mode": 420
      }
    ]
  },
  "systemd": {
    "units": [
      {
        "contents": "[Unit]\nDescription=Custom ucore autorebase to unsigned OCI and reboot\nConditionPathExists=!/etc/custom-ucore-autorebase/unverified\nConditionPathExists=!/etc/custom-ucore-autorebase/signed\nAfter=network-online.target\nWants=network-online.target\n[Service]\nType=oneshot\nStandardOutput=journal+console\nExecStart=/usr/bin/rpm-ostree rebase --bypass-driver ostree-unverified-registry:ghcr.io/clusterfault/custom-ucore:latest\nExecStart=/usr/bin/touch /etc/custom-ucore-autorebase/unverified\nExecStart=/usr/bin/systemctl disable custom-ucore-unsigned-autorebase.service\nExecStart=/usr/bin/systemctl reboot\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "custom-ucore-unsigned-autorebase.service"
      },
      {
        "contents": "[Unit]\nDescription=Custom ucore autorebase to signed OCI and reboot\nConditionPathExists=/etc/custom-ucore-autorebase/unverified\nConditionPathExists=!/etc/custom-ucore-autorebase/signed\nAfter=network-online.target\nWants=network-online.target\n[Service]\nType=oneshot\nStandardOutput=journal+console\nExecStart=/usr/bin/rpm-ostree rebase --bypass-driver ostree-image-signed:docker://ghcr.io/ghcr.io/clusterfault/custom-ucore:latest\nExecStart=/usr/bin/touch /etc/custom-ucore-autorebase/signed\nExecStart=/usr/bin/systemctl disable custom-ucore-signed-autorebase.service\nExecStart=/usr/bin/systemctl reboot\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "custom-ucore-signed-autorebase.service"
      },
      {
        "contents": "[Unit]\nDescription=Install k3s dependencies\nWants=network-online.target\nAfter=network-online.target\nBefore=zincati.service\nConditionPathExists=/etc/custom-ucore-autorebase/unverified\nConditionPathExists=/etc/custom-ucore-autorebase/signed\nConditionPathExists=|!/usr/bin/kubectl\nConditionPathExists=|!/usr/share/selinux/packages/k3s.pp\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nExecStart=/usr/bin/rpm-ostree install --allow-inactive --assumeyes kubectl k3s-selinux\nExecStart=/usr/bin/systemctl disable install-k3s-dependencies.service\nExecStart=/usr/bin/systemctl reboot\n\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "install-k3s-dependencies.service"
      },
      {
        "contents": "[Unit]\nDescription=Run K3s\nWants=network-online.target\nAfter=network-online.target\n\n[Service]\nType=notify\nEnvironmentFile=-/etc/default/%N\nEnvironmentFile=-/etc/sysconfig/%N\nEnvironmentFile=-/etc/systemd/system/%N.env\nKillMode=process\nDelegate=yes\nLimitNOFILE=1048576\nLimitNPROC=infinity\nLimitCORE=infinity\nTasksMax=infinity\nTimeoutStartSec=0\nRestart=always\nRestartSec=5s\nExecStartPre=-/sbin/modprobe br_netfilter\nExecStartPre=-/sbin/modprobe overlay\nExecStart=/usr/local/bin/k3s server  --write-kubeconfig-mode \"0644\"  --kubelet-arg=\"config=/etc/rancher/k3s/kubelet.config\"\n\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "k3s.service"
      },
      {
        "contents": "[Unit]\nDescription=Copy kubeconfig\nBefore=zincati.service\nConditionPathExists=/etc/rancher/k3s/k3s.yaml\n\n[Service]\nType=oneshot\nRemainAfterExit=yes\nExecStartPre=/usr/bin/mkdir -p /home/core/.kube\nExecStart=/usr/bin/cp /etc/rancher/k3s/k3s.yaml /home/core/.kube/config\nExecStart=/usr/bin/systemctl disable copy-kubeconfig.service\n\n[Install]\nWantedBy=multi-user.target\n",
        "enabled": true,
        "name": "copy-kubeconfig.service"
      }
    ]
  }
}
